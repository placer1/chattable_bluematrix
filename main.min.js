var chattable = {
  settings : {
    visible : true,
    theme : false
  },
  returnFrame : function(){
    var frame = document.getElementById('chattable');;
    if(frame){
      return frame;
    } else {
      console.error("No Chattable interface was detected on your page. Your iframe's id must be set to 'chattable' to use Chattable.");
      return null;
    }
  },
  loadStyle : function(source){
    var src = new XMLHttpRequest();
    src.open("GET", source, true);
    src.responseType = "text";
    src.onload = function(){
      if(src.readyState === src.DONE){
        if(src.status === 200){
          var ChatUI = chattable.returnFrame();
          src = src.response;
          if(ChatUI){
            window.chattableStylesheet = src;
            ChatUI.addEventListener("load", function(){
              ChatUI.contentWindow.postMessage(window.chattableStylesheet, "*");
            });
            try {
              ChatUI.contentWindow.postMessage(window.chattableStylesheet, "*");
            } catch(err){
              console.warn("The current web page is loading slower than the iframe, but that's okay.");
            }
          } else {
            console.error("Unable to load CSS onto live chat, the chat is not ready.");
          }
          
        } else {
          console.error("Could not locate file. Check the link and try again. " + parameters.stylesheet + ";" + src.status);
          return false;
        }
      }
    };
    src.send(null);
  },
  initialize : function(parameters){
    // console.clear();
    if(parameters){
      if(parameters.stylesheet){
        chattable.loadStyle(parameters.stylesheet);
      }
      if(parameters.theme){
        var themes = {
		  "blue matrix" : "https://raw.githubusercontent.com/placer1/chattable_bluematrix/main/bluematrix.css",
          "hacker terminal" : "https://iframe.chat/demo/hacker.css",
          "amber" : "https://iframe.chat/demo/amber.css",
          "comment section" : "https://iframe.chat/demo/comment.css",
          "confidential" : "https://iframe.chat/demo/confidential.css",
          "notepad" : "https://iframe.chat/demo/notepad.css",
          "pastel pink" : "https://iframe.chat/demo/pastel.css",
          "moderno" : "https://iframe.chat/demo/moderno.css",
          "retrowave red" : "https://iframe.chat/demo/red.css",
          "windows xp" : "https://iframe.chat/demo/xp.css",
          "kick" : "https://iframe.chat/demo/kick.css",
          
        };
        if(themes[parameters.theme.toLowerCase()]){
          chattable.loadStyle(themes[parameters.theme.toLowerCase()]);
        }
      }
    }
  },
  reintitialize : function(parameters){
    var ChatUI = chattable.returnFrame();
    if(parameters){
      if(parameters.stylesheet){
        var src = new XMLHttpRequest();
        src.open("GET", parameters.stylesheet, true);
        src.responseType = "text";
        src.onload = function(){
          if(src.readyState === src.DONE){
            if(src.status === 200){
              src = src.response;
              window.chattableStylesheet = src;
              if(ChatUI){
                ChatUI.contentWindow.location.reload();
                ChatUI.addEventListener("load", function(){
                  ChatUI.contentWindow.postMessage(window.chattableStylesheet, "*");
                });
                try {
                  ChatUI.contentWindow.postMessage(window.chattableStylesheet, "*");
                } catch(err){
                  console.warn("The current web page is loading slower than the iframe, but that's okay.");
                }
              } else {
                console.error("Unable to load CSS onto live chat, the chat is not ready.");
              }
              
            } else {
              console.error("Could not locate file. Check the link and try again. " + parameters.stylesheet + ";" + src.status);
              return false;
            }
          }
        };
        src.send(null);
      }
    }
  },
  minimize : function(){
    var ChatUI = chattable.returnFrame();
    var defaultStyle = ChatUI.style.transition;
    chattable.settings.oldHeight = ChatUI.style.height ? ChatUI.style.height : ChatUI.offsetHeight;
    chattable.settings.oldStyle = ChatUI.style;
    
    ChatUI.style.transition = "all 500ms ease-out";
    ChatUI.style.minHeight = "0";
    ChatUI.style.height = "0";
    setTimeout(function(){
      ChatUI.style.transition = defaultStyle;
      chattable.settings.visible = false;
    }, 500);
  },
  maximize : function(){
    var ChatUI = chattable.returnFrame();
    ChatUI.style.transition = "all 500ms ease-out";
    ChatUI.style.height = parseInt(chattable.settings.oldHeight) + "px";
    setTimeout(function(){
      ChatUI.style = chattable.settings.oldStyle;
      chattable.settings.visible = true;
    }, 500);
  },
  connect : function(chat_id){
    var newURL = "https://chattable.neocities.org/embed?chat=" + chat_id;
    chattable.returnFrame().src = newURL;
  }
};